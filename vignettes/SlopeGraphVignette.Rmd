---
title: "Revised/Improved Slope Graph"
author: "Rob Schick"
date: "29 January 2016"
output: word_document
---

```{r, setup, echo=FALSE, warning=FALSE, message=FALSE}
rm(list = ls())
set.seed(314)
library(ggplot2)
library(readr)
library(knitr)
library(dplyr)
library(stringr)
```

# Data Simulation
## Population Data
The goal of this is to write a short simulation that generates data of health anomaly at three points:

1. The start of an entanglement window
2. The end of an entanglement window
3. 12 months after the end of the window

We are doing this in order to look at a different way of displaying the slope plots that show decline in health. So let's make some data:

```{r}
gearInj <- 1:6
gvec1 <- c('Gear', 'Gear', 'No Gear', 'Gear', 'No Gear', 'No Gear')
gvec1 <- factor(gvec1, levels = c('No Gear', 'Gear'))
gvec2 <- c('Severe', 'Moderate', 'Severe', 'Minor', 'Moderate', 'Minor')
gvec3 <- c('Severe Gear', 'Moderate Gear', 'Severe No Gear', 'Minor Gear', 'Moderate No Gear', 'Minor No Gear')
gvec3 <- factor(gvec3, levels = c('Minor No Gear', 'Minor Gear', 'Moderate No Gear', 'Moderate Gear','Severe No Gear','Severe Gear'))
ncat <- length(gearInj)
num <- c(29, 19, 12, 18, 96, 341)

dat <- data.frame(gearInjury = gearInj,
                  gearLab1 = gvec1,
                  gearLab2 = gvec2,
                  gearLab3 = gvec3,
                  numEvents = num)
dat
```

## Health Anomaly Data
That's the basic data about numbers, events, etc. Now we need to simulate health anomaly data. To build this data base, I'm going to make a few assumptions:

1. I'm going to assume the anomalies from start to end increase as the severity increases
2. I'm going to assume the anomalies from end to recovery decrease as the severity decreases, i.e. animals with more severe entanglements are less likely to recover
3. I'm going to assume smaller variance as `num` increases

So the pseudocode for the simulation is as follows: 

1. go through each entanglement category, `i`
2. prepare a data frame with 7 columns where `nrows == num[i]` 
3. Draw `num[i]` starting values
4. Draw `num[i]` ending values
5. Draw `num[i]` recovery values

The data will look like this:

EGNo | Ent ID | gearInjury | gearLab | Start | End | Recover 
-----|----|----|----|----|----|----|----
1014 | 1 | 1 | Severe Gear | 0.05 | -15 | -13 
2320 | 3 | 4 | Minor Gear | 1 | -3 | 0.0

Now we'll build a few things in `R`. First we initialise and partially fill a data frame to hold the simulated values.

```{r}
hdat <- data.frame(EGNo = floor(runif(n = sum(num), min = 1004, max = 3000)),
                   EntID = sample(1:4, size = sum(num), replace = TRUE),
                   gearInjury = rep(dat$gearInjury, times = dat$numEvents),
                   gearlab1 = rep(dat$gearLab1, times = dat$numEvents),
                   gearlab2 = rep(dat$gearLab2, times = dat$numEvents),
                   gearlab3 = rep(dat$gearLab3, times = dat$numEvents),
                   shAnom = rnorm(sum(num), sd = 2))
head(hdat)
```

Now we'll have to add in the simulated values for end health anomaly and recovery health anomaly as a function of entanglement injury.

```{r}
hdat$ehAnom <- c(rnorm(n = dat$numEvents[1], mean = -15),
                 rnorm(n = dat$numEvents[2], mean = -12.5),
                 rnorm(n = dat$numEvents[3], mean = -13),
                 rnorm(n = dat$numEvents[4], mean = -10),
                 rnorm(n = dat$numEvents[5], mean = -8),
                 rnorm(n = dat$numEvents[6], mean = -2))

hdat$rhAnom <- c(rnorm(n = dat$numEvents[1], mean = -15),
                 rnorm(n = dat$numEvents[2], mean = -7.5),
                 rnorm(n = dat$numEvents[3], mean = -13),
                 rnorm(n = dat$numEvents[4], mean = -1),
                 rnorm(n = dat$numEvents[5], mean = -2),
                 rnorm(n = dat$numEvents[6], mean = 0))
head(hdat)
```

Let's summarise that so we can use it to draw a summary line on top of the individual lines.

```{r}
hsum <- hdat %>% 
  dplyr::group_by(gearlab1, gearlab2) %>% 
  dplyr::summarise(smed = median(shAnom),
            emed = median(ehAnom),
            rmed = median(rhAnom))
hsuml <- reshape2::melt(hsum, id.vars = c('gearlab1', 'gearlab2'))
hsuml$x <- rep(0:2, each = 6)
head(hsuml)
```


## Slope Graph
This one is similar to the last slope graph, but splits out into individual facets and displays the data from all the lines in addition to the summary line. By including all of the lines, we get a visual sense of the amount in each category. But by adding them in, we also would occlude some of the trends at the start. So I've splot them out into facets. 

```{r}
p <- ggplot(data = hdat)+
  geom_segment(aes(y = shAnom, yend = ehAnom, x = 0, xend = 1), colour = alpha('grey', 0.5)) +
  geom_segment(aes(y = ehAnom, yend = rhAnom, x = 1, xend = 2), colour = alpha('grey', 0.5))+
  geom_path(data = test, aes(y = value, x = x), lwd = 1.5) + 
    scale_x_continuous(breaks = c(0, 1, 2),
                   labels = c( 'Start', 'End', 'After\n12 Months'))+
  facet_grid(gearlab1 ~ gearlab2)+
  theme_bw()+
  theme(panel.grid.minor.x = element_blank())+
  labs(x = '', y = 'Health Anomaly')
p
```


## Horizontal Bar Plot
Ok, with the previous graph, we get a sense of the trends within each entanglement category. However, we also, as a glance, want to see the change by category. So do do that, I'm going to build a horizontal bar plot. First I'll get summary measures from the summary data. These will be the differences between the start and end, and the end and the recovery:

```{r}
# hsum2 <- 
#   hsum %>% 
#   group_by(gearlab1, gearlab2) %>% 
#   summarise(diff1 = emed - smed,
#             diff2 = rmed - emed)
# hsum2

hsum <- hdat %>% 
  group_by(gearlab1, gearlab2, gearlab3) %>% 
  mutate(diff1 = ehAnom - shAnom, 
         diff2 = rhAnom - ehAnom) %>% 
  summarise(diff1med = median(diff1),
            diff2med = median(diff2))
hsum

hsuml <- reshape2::melt(hsum, id.vars = c('gearlab1', 'gearlab2', 'gearlab3'), measure.vars = c('diff1med', 'diff2med'))
hsuml$pos <- hsuml$value > 0
```

Ok, now let's make the plot

```{r}
p2 <- ggplot(hsuml, aes(x = gearlab3, y = value, fill = variable)) +
  geom_bar(stat = 'identity', position = 'identity')+
  coord_flip()+
  labs(x = '', y = 'Health Deviation Across Time', fill = c('Time Period'))+
  scale_fill_brewer(type = 'qual', palette = 'Dark2', direction = -1, labels = c('Entanglement\nWindow', 'Recovery\nWindow'))+
  theme_bw()
p2
```


## Both Plots together
With them made, then let's arrange them into one panel.

```{r}
library(gridExtra)
grid.arrange(p, p2, ncol=1, heights = c(0.7,  0.3))
```


