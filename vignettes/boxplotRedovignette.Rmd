---
title: "Re-Do of Boxplot Plot"
author: "Rob Schick"
date: "`r Sys.Date()`"
output: word_document
---

This is a short file to describe how I've reworked the analysis of the health during entanglements to create the boxplots. The goal in the end is to have a series of paired boxplots showing health anomaly during the entanglment window for both non-reproductive animals and reproductive females. This will also include a comparison of unimpacted animals for reference.

The reason we're re-doing this, is because the way I had extracted the health data before, was using the `R` command `tapply()`, which is fine. However, what this did was to take multiple events of the same type for each animal, and return one health value. So in the end, that created labels above the boxplots that didn't necessariy match up to the number of different entanglement events.

## Updated Analysis
So what I've done is only slightly different, but the processing logic is as follows:

1. Take the entanglement event data
2. Loop over it one line at a time, e.g. one event per animal
3. Extract the starting month of the window
4. Extract the end month of the window
5. Tally the number of months
6. Extract the entanglement event number
7. Use start/end to extract and return the median health anomaly across the event

Once all of that is done, we summarise across unimpacted/impacted and repro/non-repro and make a boxplot.

So this is what the entanglement data look like that we loop over (note that these are old data; I'll be updating these with the new data after the most recent runs finish):

```{r}
load(file="../data/egAmyEntData.rdata") 
tangRepro[1:6, 1:6]
```

Ok, then we loop over those, intersecting them with estimates of the health anomaly and summarise (in this case we return and store the median health anomaly during each event). At the end of this looping the new data look like this:

```{r, echo=FALSE, warning=FALSE, message=FALSE}
library(dplyr)
load(file = '../data/healthEntanglementWindowDataBoth.rdata')
dfLong <- rbind(dfLongRepro, dfLongNonRepro)
head(dfLong)
```

We can quickly summarise that to get a feel for how health changes as a function of gear injury type:

```{r}
dfLong %>% 
  group_by(gearInj) %>% 
  summarise(anomaly = median(hAnom))
```

And a reminder that this is the order of the categories:

gearInj | Definition
-----------|----------
0 | Unimpacted
1 | Severe with gear
2 | Moderate with gear
3 | Severe no gear
4 | Minor with gear
5 | Moderate no gear
6 | Minor no gear

## The Revised Plot
Ok, so then let's remake the plot:

```{r, echo=FALSE, fig.width = 8}
library(ggplot2)
dfLong <- rbind(dfLongRepro, dfLongNonRepro)
namevec = c('Unimpacted'=0, 'Minor No Gear'=6, 'Minor Gear'=4, 'Moderate No Gear'=5,
            'Moderate Gear'=2, 'Severe No Gear'=3, 'Severe Gear'=1)

nvals <- as.data.frame(table(dfLong$status, dfLong$gearInj))

nvals$label <- namevec[nvals$Var2]

plabel <- c(nvals$Freq[nvals$Var1 == 'NonRepFem' & nvals$Var2 == 6], 
            nvals$Freq[nvals$Var1 == 'RepFem' & nvals$Var2 == 6], 
            nvals$Freq[nvals$Var1 == 'NonRepFem' & nvals$Var2 == 4], 
            nvals$Freq[nvals$Var1 == 'RepFem' & nvals$Var2 == 4], 
            nvals$Freq[nvals$Var1 == 'NonRepFem' & nvals$Var2 == 5], 
            nvals$Freq[nvals$Var1 == 'RepFem' & nvals$Var2 == 5], 
            nvals$Freq[nvals$Var1 == 'NonRepFem' & nvals$Var2 == 2], 
            nvals$Freq[nvals$Var1 == 'RepFem' & nvals$Var2 == 2], 
            nvals$Freq[nvals$Var1 == 'NonRepFem' & nvals$Var2 == 3], 
            nvals$Freq[nvals$Var1 == 'RepFem' & nvals$Var2 == 2], 
            nvals$Freq[nvals$Var1 == 'NonRepFem' & nvals$Var2 == 1], 
            nvals$Freq[nvals$Var1 == 'RepFem' & nvals$Var2 == 1])

# the shading will be repro vs non-repro
p <- ggplot(dfLong, aes(x = factor(gearInj, levels = c(0, 6, 4, 5, 2, 3, 1)), y = hAnom)) +
  geom_hline(aes(yintercept = 0), colour = 'grey50')+
  geom_boxplot(aes(fill = factor(status), group = paste(factor(gearInj), status)), outlier.shape=NA, notch = FALSE)+
  annotate('text', x = c(1 + 0.82, 1 + 1.18, 1 + 1.82, 1 + 2.18, 1 + 2.82, 1 + 3.18,
                         1 + 3.82, 1 + 4.18, 1 + 4.82, 1 + 5.18, 1 + 5.82, 1 + 6.18), y = 25, 
           label = plabel, cex = 5)+
  labs(y = 'Deviation From Population Health', x = 'Injury Status', fill = 'Reproductive Status')+
  scale_x_discrete(labels = c('Unimpacted', 'Minor\nNo Gear', 'Minor\nGear', 'Moderate\nNo Gear','Moderate\nGear',   'Severe\nNo Gear', 'Severe\nGear'))+
  
  scale_fill_grey(start = 1, end = 0.65,labels = c('All Other\nDemographic\nCategories\n', 'Reproductive\nFemales\n'))+
  theme_bw(base_size = 16)
p
```

A few extras. First, I've added in a horizontal line at `y = 0` just for extra visual reference. Second, the numbers above the boxes now make a bit more sense. Here's the total tally (recall again that these are old entanglement data - not the ones that Philip has just exported). Total number of events: ```r sum(plabel)``` Finally, the plot is squashed in the word doc, but the full pdf is better, and prevents label overplotting.

I like this; but do let me know what you think.


