---
title: "Evaluation of Health and Pregnancy Success"
author: "Rob Schick"
date: "`r Sys.Date()`"
output: html_document
---

```{r global_options, echo=FALSE, warning=FALSE, message=FALSE}
knitr::opts_chunk$set(warning=FALSE, message=FALSE)

library(tangled)
library(tidyverse)
library(ggplot2)
library(gghighlight)
library(lme4)
library(lattice)
```

The goal of this vignette is to describe health during available years by building up a data frame where the dependent variable is success of pregnancy, and the covariates are as follows:

1. Health during available year
2. whether the animal was entangled or not during the available year
3. severity of entanglement
4. time since last pregnancy
5. decade

We begin by preparing the data.

## Data Preparation
We have two different data frames that we need to work with: 1)  the list of every known pregnancy event, and 2) the individual estimates of health that form the core of the model output.

### Pregnancy Data

```{r}
pregnant <- read_csv(here::here('data-raw', '2021-01-08_years_since_pregnancy_ark.csv'))%>% 
  select(!starts_with('X')) %>% 
  filter(Year >=1980 & Year <= 2013) %>% 
  drop_na(Pregnant)

pregnant$Pregnant[pregnant$Pregnant == 'F'] <- '1'
pregnant$Pregnant <- as.numeric(pregnant$Pregnant)

# pregnant_old <- read_csv(here::here('data-raw', '2020-10-20_pregnancy_yes-no.csv')) %>%
# select(!starts_with('X')) %>%
# filter(Year >=1980 & Year <= 2013)
```

### Health and Entanglement data
Now that we have the dependent variables, we need to build up the information on health and entanglement status. Let's do health first

```{r}
healthmean <- sumh / ng
pregnant$health <- 0
pregnant$health_min <- 0

for(i in 1:nrow(pregnant)){
    
  rowidx <- match(pregnant$EGNo[i], ID)
  s <- match(paste0("1-", pregnant$Year[i]), myName)
  e <- match(paste0("12-", pregnant$Year[i]), myName)
  colidx <- s:e  
  pregnant$health[i] <- mean(healthmean[rowidx, colidx], na.rm = TRUE)
  pregnant$health_min[i] <- min(healthmean[rowidx, colidx], na.rm = TRUE)
}
```

Then we add in the decadal information that we'll use as a factor covariate and possible as an interaction term.

```{r}
pregnant <- pregnant %>% 
  mutate(decade = case_when(Year >= 1980 & Year <= 1989 ~ 1980,
                            Year >= 1990 & Year <= 1999 ~ 1990,
                            Year >= 2000 & Year <= 2009 ~ 2000,
                            Year >= 2010 & Year <= 2019 ~ 2010))
```

Ok, let's move on to the entanglement data. What I'm after now are whether or not the animal was entangled in a given available year, and if so what the severity was.


```{r}
ent_tidy <- read_csv(here::here('data-raw','2020-09-29-entanglement_tidy.csv')) %>% 
  select(!starts_with('X')) %>% 
  select(!starts_with('Created')) %>% 
  select(!starts_with('Edited')) %>% 
  select(!starts_with('Change')) %>% 
  mutate(year = lubridate::year(lubridate::dmy(EndDate)))

```

We wish to intersect these to bring the entanglement information across. In particular, we need `severity`.

```{r }
pregnant$severity <- 'unentangled'

for (i in 1:nrow(pregnant)){
  # Get the Animal out and the year out for looking at the entanglement data
  egno_p <- pregnant$EGNo[i]
  year_p <- pregnant$Year[i]
  
  # subset the entanglement data to just pull out the 
  dsub <- ent_tidy %>% 
    filter(EGNo == egno_p & year == year_p)
  
  if(nrow(dsub) == 0) next()
  if(nrow(dsub) > 1) print(i) # note that while these are both cases where the status is the same, you should add a rule for error trapping if/when more data come in
  pregnant$severity[i] <- dsub$EntanglementStatus
  
}

```

### Covariate Creation and Standardization
Before we run the glm, we need to get the reference levels correct for the entanglement severity, and I want to make a binomial column for entanglement status. I also want to standardize the year covariate

```{r}
pregnant$severity <- factor(pregnant$severity, levels = c('unentangled', 'minor', 'moderate', 'severe')) 
pregnant <- pregnant %>% 
  mutate(ent_status = if_else(severity == 'unentangled', 0, 1)) %>% 
  mutate(ent_status_2 = case_when(severity == 'unentangled' ~ 'unentangled',
                            severity == 'minor' ~ 'minor',
                            severity == 'moderate' ~ 'mod_sev',
                            severity == 'severe' ~ 'mod_sev'))

pregnant$ent_status_2 <- factor(pregnant$ent_status_2, levels = c('unentangled', 'minor', 'mod_sev')) 

mn_year <- mean(pregnant$Year)
sd_year <- sd(pregnant$Year)
pregnant$std_year <- (pregnant$Year - mn_year) / sd_year

pregnant$elapsed <- as.numeric(pregnant$elapsed)
pregnant$fctr_yr <- factor(pregnant$Year)
pregnant$EGNo <- factor(pregnant$EGNo)
pregnant$health_scl <- (pregnant$health - mean(pregnant$health, na.rm = TRUE)) / sd(pregnant$health, na.rm = TRUE)
pregnant$health_min_scl <- (pregnant$health_min - mean(pregnant$health_min, na.rm = TRUE)) / sd(pregnant$health_min, na.rm = TRUE)
```

Calculating elapsed times. We need two final covariates:

1. Time since last entanglement
2. Time since last calving  (Amy made this)

```{r}
# block from function to go in here
```


## Model Fits
We'll run two binomial glms that only vary in how the entanglement covariate is constructed. In the first, it will be simply unentangled vs. entangled; in the second, we will have the 3 standard levels of entanglement


```{r}
fit1 <- glm(Pregnant ~ health_scl + ent_status + std_year + factor(decade), data = pregnant, family = binomial(link = "logit"), na.action = na.exclude)
summary(fit1)
```

Now we'll examine a covariate with all 4 levels of entanglement (not-entangled, minor, moderate, severe).

```{r}
fit2 <- glm(Pregnant ~ health_scl + severity + std_year + factor(decade), data = pregnant, family = binomial(link = "logit"))
summary(fit2)
```

Since it looks like there's an effect of entanglement, but owing to the relatively few cases for severe, I'm going to try and lump the severe and moderate to see if I can tease out a signal.

```{r}
fit3 <- glm(Pregnant ~ health_scl + ent_status_2 + std_year + factor(decade), data = pregnant, family = binomial(link = "logit"))
summary(fit3)
```


### Just Looking at the "Complete Cases"

```{r}
preg_sub <- pregnant %>% 
  filter(severity != 'unentangled')

fit3 <- glm(Pregnant ~ health_scl + Year + factor(decade) + severity, data = preg_sub, family = binomial(link = "logit"))
summary(fit3)
```

## Random Effects
### Let's start with a test for individual

```{r}
fit.re <- glmer(Pregnant ~ health_scl + health_min_scl + (1 | EGNo) + std_year, data = pregnant, family = binomial)

```

With it fit, let's summarize, and look at the coefficients.

```{r}
summary(fit.re)
# coef(fit.re)
```

Ok, and then let's plot that out:

```{r}
qqmath(ranef(fit.re))
```

### Let's use with a test for severity

Note that I can't get this to fit
```{r}
fit.re <- glmer(Pregnant ~ health_scl + (1 | decade) + severity, data = pregnant, family = binomial)

```

With it fit, let's summarize, and look at the coefficients.

```{r}
summary(fit.re)
coef(fit.re)
```

Ok, and then let's plot that out:

```{r}
qqmath(ranef(fit.re))
```
### Time Since Last Entanglement

```{r}


dsub <- pregnant %>% 
  # dplyr::slice_head(n = 250) %>%
  select(EGNo, Year, Pregnant) %>% 
  arrange(EGNo, Year)
egno <- unique(dsub$EGNo)
# id <- 1013 # testing
# loop over animals
df_all <- numeric(0)
for(id in egno){
  
  my_dsub <- pregnant %>% 
    filter(EGNo == id) 
  
  # Expand to fill all years
  df_exp <- data.frame(EGNo = unique(my_dsub$EGNo),
                       Year = seq(my_dsub$Year[1], 
                                       my_dsub$Year[length(my_dsub$Year)],
                                       by = 1))
  
  df <- left_join(df_exp, my_dsub, by = c('Year', 'EGNo') ) 
  df$severity <- df$severity %>%  replace_na(0)
    
    df <- df %>% 
    mutate(sev_num = case_when(severity == '0' ~ 0,
                               severity == 'unentangled' ~ 0,
              severity == 'minor' ~ 1,
              severity == 'moderate' ~ 2,
              severity == 'severe' ~ 3)) %>% 
      select(-severity)
  
  # df$sev_num <- as.numeric(df$sev_num)
  
  df <- df %>% 
    mutate(ent_group = cumsum(sev_num))
  
  df <- df %>% 
    filter(ent_group > 0) %>% 
    group_by(ent_group) %>% 
    mutate(ent_elapsed = Year - first(Year)) %>% 
    mutate(last_severity = first(sev_num)) %>% 
    ungroup(ent_group) %>%
    select(EGNo, Year, ent_elapsed, last_severity)
  
  # df_1 <- left_join(my_dsub, df, by = c('Year', 'EGNo') ) # keep rows in my_dsub
  # df_2 <- left_join(df, my_dsub, by = c('Year', 'EGNo') ) # keep rows in df

  df <- inner_join(my_dsub, df, by = c('Year', 'EGNo') ) # keep rows in my_dsub
  
  df_all <- rbind(df_all, df)
}
write_csv(df_all, '../data/years_since_entanglement.csv')

# time since last entanglement
mn_year <- mean(df_all$Year)
sd_year <- sd(df_all$Year)
df_all$std_year <- (df_all$Year - mn_year) / sd_year

df_all$elapsed <- as.numeric(df_all$elapsed + 1)
df_all$ent_elapsed <- as.numeric(df_all$ent_elapsed + 1)
df_all$fctr_yr <- factor(df_all$Year)
df_all$EGNo <- factor(df_all$EGNo)
df_all$health_scl <- (df_all$health - mean(df_all$health, na.rm = TRUE)) / sd(df_all$health, na.rm = TRUE)
df_all$health_min_scl <- (df_all$health_min - mean(df_all$health_min, na.rm = TRUE)) / sd(df_all$health_min, na.rm = TRUE)


fit3 <- glm(Pregnant ~ health_scl + factor(last_severity) * ent_elapsed, data = df_all, family = binomial(link = "logit"))
summary(fit3)


```

