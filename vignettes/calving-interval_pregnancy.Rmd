---
title: "Evaluation of Health and Pregnancy Success"
author: "Rob Schick"
date: "`r Sys.Date()`"
output: html_document
---

```{r global_options, echo=FALSE, warning=FALSE, message=FALSE}
knitr::opts_chunk$set(warning=FALSE, message=FALSE)

library(tangled)
library(tidyverse)
library(ggplot2)
library(gghighlight)
library(lme4)
library(lattice)
```

The goal of this vignette is to describe health during available years by building up a data frame where the dependent variable is success of pregnancy, and the covariates are as follows:

1. Health during available year
2. whether the animal was entangled or not during the available year
3. severity of entanglement
4. time since last pregnancy
5. decade

We begin by preparing the data.

## Data Preparation
We have two different data frames that we need to work with: 1)  the list of every known pregnancy event, and 2) the individual estimates of health that form the core of the model output.

### Pregnancy Data

```{r}
pregnant <- cases <- read_csv(here::here('data-raw', '2020-10-20_pregnancy_yes-no')) %>% 
  select(!starts_with('X')) %>% 
  filter(Year >=1980 & Year <= 2013)
```

### Health and Entanglement data
Now that we have the dependent variables, we need to build up the information on health and entanglement status. Let's do health first

```{r}
healthmean <- sumh / ng
pregnant$health <- 0
pregnant$health_min <- 0

for(i in 1:nrow(pregnant)){
    
  rowidx <- match(pregnant$EGNo[i], ID)
  s <- match(paste0("1-", pregnant$Year[i]), myName)
  e <- match(paste0("12-", pregnant$Year[i]), myName)
  colidx <- s:e  
  pregnant$health[i] <- mean(healthmean[rowidx, colidx], na.rm = TRUE)
  pregnant$health_min[i] <- min(healthmean[rowidx, colidx], na.rm = TRUE)
}
```

Then we add in the decadal information that we'll use as a factor covariate and possible as an interaction term.

```{r}
pregnant <- pregnant %>% 
  mutate(decade = case_when(Year >= 1980 & Year <= 1989 ~ 1980,
                            Year >= 1990 & Year <= 1999 ~ 1990,
                            Year >= 2000 & Year <= 2009 ~ 2000,
                            Year >= 2010 & Year <= 2019 ~ 2010))
```

Ok, let's move on to the entanglement data. What I'm after now are whether or not the animal was entangled in a given available year, and if so what the severity was.


```{r}
ent_tidy <- read_csv(here::here('data-raw','2020-09-29-entanglement_tidy.csv')) %>% 
  select(!starts_with('X')) %>% 
  select(!starts_with('Created')) %>% 
  select(!starts_with('Edited')) %>% 
  select(!starts_with('Change')) %>% 
  mutate(year = lubridate::year(lubridate::dmy(EndDate)))

```

We wish to intersect these to bring the entanglement information across. In particular, we need `severity`.

```{r }
pregnant$severity <- 'unentangled'

for (i in 1:nrow(pregnant)){
  # Get the Animal out and the year out for looking at the entanglement data
  egno_p <- pregnant$EGNo[i]
  year_p <- pregnant$Year[i]
  
  # subset the entanglement data to just pull out the 
  dsub <- ent_tidy %>% 
    filter(EGNo == egno_p & year == year_p)
  
  if(nrow(dsub) == 0) next()
  if(nrow(dsub) > 1) print(i) # note that while these are both cases where the status is the same, you should add a rule for error trapping if/when more data come in
  pregnant$severity[i] <- dsub$EntanglementStatus
  
}

```

Before we run the glm, we need to get the reference levels correct for the entanglement severity, and I want to make a binomial column for entanglement status. I also want to standardize the year covariate

```{r}
pregnant$severity <- factor(pregnant$severity, levels = c('unentangled', 'minor', 'moderate', 'severe')) 
pregnant <- pregnant %>% 
  mutate(ent_status = if_else(severity == 'unentangled', 0, 1))

mn_year <- mean(pregnant$Year)
sd_year <- sd(pregnant$Year)
pregnant$std_year <- (pregnant$Year - mn_year) / sd_year

pregnant$fctr_yr <- factor(pregnant$Year)
pregnant$EGNo <- factor(pregnant$EGNo)
pregnant$health_scl <- (pregnant$health - mean(pregnant$health, na.rm = TRUE)) / sd(pregnant$health, na.rm = TRUE)
pregnant$health_min_scl <- (pregnant$health_min - mean(pregnant$health_min, na.rm = TRUE)) / sd(pregnant$health_min, na.rm = TRUE)
```

We'll run two binomial glms that only vary in how the entanglement covariate is constructed. In the first, it will be simply unentangled vs. entangled; in the second, we will have the 3 standard levels of entanglement


```{r}
fit1 <- glm(Pregnant ~ health_scl + health_min_scl + ent_status + std_year + factor(decade), data = pregnant, family = binomial(link = "logit"))
summary(fit1)
```

Now we'll examine a covariate with all 4 levels of entanglement (not-entangled, minor, moderate, severe).

```{r}
fit2 <- glm(Pregnant ~ health_scl + health_min_scl  + severity + std_year + factor(decade), data = pregnant, family = binomial(link = "logit"))
summary(fit2)
```

### Just Looking at the "Complete Cases"

```{r}
preg_sub <- pregnant %>% 
  filter(severity != 'unentangled')

fit3 <- glm(Pregnant ~ health_scl + Year + factor(decade) + severity, data = preg_sub, family = binomial(link = "logit"))
summary(fit3)
```

## Random Effects
### Let's start with a test for individual

```{r}
fit.re <- glmer(Pregnant ~ health_scl + health_min_scl + (1 | EGNo) + std_year, data = pregnant, family = binomial)

```

With it fit, let's summarize, and look at the coefficients.

```{r}
summary(fit.re)
# coef(fit.re)
```

Ok, and then let's plot that out:

```{r}
qqmath(ranef(fit.re))
```

### Let's use with a test for severity

Note that I can't get this to fit
```{r}
fit.re <- glmer(Pregnant ~ health_scl + health_min_scl + (1 | decade) + severity, data = pregnant, family = binomial)

```

With it fit, let's summarize, and look at the coefficients.

```{r}
summary(fit.re)
coef(fit.re)
```

Ok, and then let's plot that out:

```{r}
qqmath(ranef(fit.re))
```

