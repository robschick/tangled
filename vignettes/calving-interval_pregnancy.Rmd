---
title: "Evaluation of Health and Pregnancy Success"
author: "Rob Schick"
date: "`r Sys.Date()`"
output: html_document
---

```{r global_options, echo=FALSE, warning=FALSE, message=FALSE}
knitr::opts_chunk$set(warning=FALSE, message=FALSE)

library(tangled)
library(tidyverse)
library(ggplot2)
library(gghighlight)
library(lme4)
library(lattice)
```

The goal of this vignette is to describe health during available years by building up a data frame where the dependent variable is success of pregnancy, and the covariates are as follows:

1. Health during available year
2. whether the animal was entangled or not during the available year
3. severity of entanglement
4. time since last pregnancy
5. decade

We begin by preparing the data.

## Data Preparation
We have two different data frames that we need to work with: 1)  the list of every known pregnancy event, and 2) the individual estimates of health that form the core of the model output.

### Pregnancy Data

```{r}
pregnant <- cases <- read_csv(here::here('data-raw', '2020-08-26-pregnancy_yes-no.csv'))%>% 
  select(!starts_with('X')) %>% 
  filter(Year >=1980 & Year <= 2013)
```

### Health and Entanglement data
Now that we have the dependent variables, we need to build up the information on health and entanglement status. Let's do health first

```{r}
healthmean <- sumh / ng
pregnant$health <- 0

for(i in 1:nrow(pregnant)){
    
  rowidx <- match(pregnant$EGNo[i], ID)
  s <- match(paste0("1-", pregnant$Year[i]), myName)
  e <- match(paste0("12-", pregnant$Year[i]), myName)
  colidx <- s:e  
  pregnant$health[i] <- mean(healthmean[rowidx, colidx], na.rm = TRUE)
}
```

Then we add in the decadal information that we'll use as a factor covariate and possible as an interaction term.

```{r}
pregnant <- pregnant %>% 
  mutate(decade = case_when(Year >= 1980 & Year <= 1989 ~ 1980,
                            Year >= 1990 & Year <= 1999 ~ 1990,
                            Year >= 2000 & Year <= 2009 ~ 2000,
                            Year >= 2010 & Year <= 2019 ~ 2010))
```

Ok, let's move on to the entanglement data. What I'm after now are whether or not the animal was entangled in a given available year, and if so what the severity was.

A reminder that this is the order of the categories:

gearInj | Definition
-----------|----------
1 | Severe with gear
2 | Moderate with gear
3 | Severe no gear
4 | Minor with gear
5 | Moderate no gear
6 | Minor no gear

We take the `tangRepro` data frame that is created in the `prepAmyEntanglementData.R` script as part of `tangled` package construction. We loop over the events and extract monthly estimates of the health anomaly during the event, as well as a derived variable `lthold` that indicates the number of months (if any) the health estimate was below 67. 


```{r}
tmp <- prepBoxplotHealthData(tangRepro, tangNonRepro, anomFlag = FALSE, thold = 67)
dfLong <- bind_rows(tmp$dfLongRepro, tmp$dfLongNonRepro) %>% 
  mutate(severity = case_when(gearInj %in% c(6, 4) ~ 'minor',
                              gearInj %in% c(5, 2) ~ 'moderate',
                              gearInj %in% c(3, 1) ~ 'severe')) %>% 
  arrange(egno, eventNo)
```

At the end of this looping the new data look like this:

```{r, warning=FALSE, message=FALSE}
head(dfLong)
```

We wish to intersect these to bring the entanglement information across. In particular, we want `gearInj` and `lthold`. While we don't need `severity` since it's already in `gearInj`, I'll grab it anyway.

```{r }
pregnant$gearInj <- 0
pregnant$lthold <- NA
pregnant$severity <- 'unentangled'

for (i in 1:nrow(pregnant)){
  # Get the Animal out and the year out for looking at the entanglement data
  egno_p <- pregnant$EGNo[i]
  year <- pregnant$Year[i]
  
  # subset the entanglement data to just pull out the 
  dsub <- dfLong %>% 
    filter(egno == egno_p & endDate == year)
  
  if(nrow(dsub) == 0) next()
  
  pregnant$gearInj[i] <- dsub$gearInj
  pregnant$lthold[i] <- dsub$lthold
  pregnant$severity[i] <- dsub$severity
  
}

```

Before we run the glm, we need to get the reference levels correct for the entanglement severity, and I want to make a binomial column for entanglement status. I also want to standardize the year covariate

```{r}
pregnant$severity <- factor(pregnant$severity, levels = c('unentangled', 'minor', 'moderate', 'severe')) 
pregnant <- pregnant %>% 
  mutate(ent_status = if_else(severity == 'unentangled', 0, 1))

mn_year <- mean(pregnant$Year)
sd_year <- sd(pregnant$Year)
pregnant$std_year <- (pregnant$Year - mn_year) / sd_year
```

```{r}
fit1 <- glm(Pregnant ~ health + severity + std_year + factor(decade), data = pregnant, family = binomial(link = "logit"))
summary(fit1)
```

### Just Looking at the "Complete Cases"

```{r}
preg_sub <- pregnant %>% 
  filter(severity != 'unentangled')

fit2 <- glm(Pregnant ~ health + Year + factor(decade) + severity, data = preg_sub, family = binomial(link = "logit"))
summary(fit2)
```

## Random Effects
### Let's start with a test for individual

```{r}
pregnant$fctr_yr <- factor(pregnant$Year)
pregnant$EGNo <- factor(pregnant$EGNo)
pregnant$health_scl <- (pregnant$health - mean(pregnant$health, na.rm = TRUE)) / sd(pregnant$health, na.rm = TRUE)
fit.re <- glmer(Pregnant ~ health_scl + (1 | EGNo) + std_year, data = pregnant, family = binomial)

```

With it fit, let's summarize, and look at the coefficients.

```{r}
summary(fit.re)
# coef(fit.re)
```

Ok, and then let's plot that out:

```{r}
qqmath(ranef(fit.re))
```

### Let's use with a test for severity

Note that I can't get this to fit
```{r}
fit.re <- glmer(Pregnant ~ health_scl + (1 | EGNo) + severity, data = pregnant, family = binomial)

```

With it fit, let's summarize, and look at the coefficients.

```{r}
summary(fit.re)
coef(fit.re)
```

Ok, and then let's plot that out:

```{r}
qqmath(ranef(fit.re))
```

