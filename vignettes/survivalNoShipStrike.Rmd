---
title: "Survival of Entangled Right Whales - Excluding Those Struck and Killed by Ships"
author: "Rob Schick, PhD"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Survival of Entangled Right Whales - Excluding Those Struck and Killed by Ships}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

## Survival of Entangled Whales be Sex and Severity - Ship Struck Animals Removed
Here we extend the previous analysis to look at survivorship of entangled whales who did not die as a result of being struck by a ship. We'll do this by backing them out of the data frames used to estimate survivorship. The list of animals to be exlcuded is:

* 1128
* 1504
* 1907 (although also a severe with gear engtl)
* 1223
* 2250
* 1623
* 2220
* 2450
* 1014
* 2150
* 1004
* 1909
* 2143
* 2617
* 1267
* 3508
* 1308

Note that there are also other animals to be excluded. These are animals who had severe prop cuts the last time they were seen:
Severe prop cuts when last seen alive and now presumed dead

* 1006
* 1045
* 2404
* 2425
* 2820
* 3522
* 3853

```{r global_options, echo=FALSE}
knitr::opts_chunk$set(warning=FALSE, message=FALSE)
```


```{r,echo=FALSE, loadLibraries}
library(tangled)
library(magrittr)
library(dplyr)
library(ggplot2)
```

## Drop the Ship-Struck Animals
To get and store just that last event, we call a function called `makeEvents()`, which will prepare a data frame of the last entanglement event of each animal and add some identifying information about its death status (see next section for details). However, as compared to the regular survival analysis, here we'll back out the animals in the list above:

```{r, pullOutAnimals}
events <- makeEvents()
nrow(events)
avec <- c(1128, 1504, 1907, 1223, 2250, 1623, 2220, 2450, 1014, 2150, 1004, 1909, 2143, 2617, 1267, 3508, 1308,
          1006, 1045, 2404, 2425, 2820, 3522, 3853)
events <- dplyr::filter(events, !EGNo %in% avec)
nrow(events)

```

```{r, echo=FALSE, addGender}
events$gender <- gender[match(events$EGNo, ID)]
labs <- events %>% group_by(Severity, gender) %>% summarise(total = n())
legendLabs <- c(paste('Minor (F = ', labs[1, 3], ', M = ', labs[2, 3], ')', sep = ''),
                paste('Moderate (F = ', labs[3, 3], ', M = ', labs[4, 3], ')', sep = ''),
                paste('Severe (F = ', labs[5, 3], ', M = ', labs[6, 3], ')', sep = ''))
```

## Calculate Survivorship
```{r, calcSurvivorship}
kdpasurvldf <- calckdpaSurvdat(events)
survdf <- calcpresdSurvdat(events, kdpasurvldf)
```




## Survival of Entangled Whales be Sex and Severity
Ok, the processing logic is identical to that above, but the functions differ in the sense that they split out the data by gender and severity. This will likely be the figure we use for the manuscript. I'm going to plot it without uncertainty here, and I'll stop the plotting at 6 years following entanglement.

```{r, fig.width=8,fig.height=6, plotKMCurves}
incVal <- 12
yearsOut <- 6
tmp <- calcKMCurvesSevGen(survdf, kdpasurvldf, nboot = 1, dcut, increment = incVal, medProb = TRUE)
p <- plotSurvGenderSeverity(tmp$kmlines, tmp$censTicks, yearEnd = yearsOut, increment = incVal, legendLabs)
p
ggsave(plot = p, filename = 'survivalGenderSeverity_NoShipStrike.pdf',
       path = '/Users/rob/Dropbox/Papers/KnowltonEtAl_Entanglement/images', device = 'pdf', width = 9, height = 6, units = 'in')
ggsave(plot = p, filename = 'survivalGenderSeverity_NoShipStrike.png',
       path = '/Users/rob/Dropbox/Papers/KnowltonEtAl_Entanglement/images', device = 'png', dpi = 300, width = 9, height = 6, units = 'in', scale = 0.8)
```
